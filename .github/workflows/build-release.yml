name: Build Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  QT_VERSION: '6.5.3'
  CMAKE_VERSION: '3.28.0'
  BUILD_TYPE: Release

jobs:
  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        cache: true
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '17'
    
    - name: Install vcpkg dependencies
      run: |
        vcpkg install zlib:x64-windows bzip2:x64-windows liblzma:x64-windows
        vcpkg integrate install
    
    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}" `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
    
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
    
    - name: Run Tests
      working-directory: build/Release/Release
      run: |
        # Run each test executable
        $tests = Get-ChildItem -Filter "test_*.exe"
        foreach ($test in $tests) {
          Write-Host "Running $($test.Name)..."
          & ".\$($test.Name)"
          if ($LASTEXITCODE -ne 0) {
            Write-Warning "Test $($test.Name) failed with exit code $LASTEXITCODE"
          }
        }
      continue-on-error: true
    
    - name: Package Application
      working-directory: build/Release
      run: |
        # Create release directory
        New-Item -ItemType Directory -Force -Path "SAK-Utility-v0.5.1"
        
        # Copy executable
        Copy-Item "sak_utility.exe" "SAK-Utility-v0.5.1/"
        
        # Copy Qt DLLs and dependencies (already deployed by CMake)
        $qtDirs = @(
          "platforms",
          "styles",
          "imageformats",
          "tls",
          "translations"
        )
        foreach ($dir in $qtDirs) {
          if (Test-Path $dir) {
            Copy-Item -Recurse $dir "SAK-Utility-v0.5.1/"
          }
        }
        
        # Copy Qt runtime DLLs
        $qtDlls = Get-ChildItem -Filter "Qt6*.dll"
        foreach ($dll in $qtDlls) {
          Copy-Item $dll.FullName "SAK-Utility-v0.5.1/"
        }
        
        # Copy MSVC runtime DLLs if present
        $msvcDlls = Get-ChildItem -Filter "vcruntime*.dll" -ErrorAction SilentlyContinue
        foreach ($dll in $msvcDlls) {
          Copy-Item $dll.FullName "SAK-Utility-v0.5.1/"
        }
        
        # Copy tools directory if exists
        if (Test-Path "../../tools") {
          Copy-Item -Recurse "../../tools" "SAK-Utility-v0.5.1/"
        }
        
        # Copy documentation
        Copy-Item "../../Readme.md" "SAK-Utility-v0.5.1/"
        Copy-Item "../../LICENSE" "SAK-Utility-v0.5.1/"
        if (Test-Path "../../CONTRIBUTING.md") {
          Copy-Item "../../CONTRIBUTING.md" "SAK-Utility-v0.5.1/"
        }
        
        # Create portable.ini for portable mode
        New-Item -ItemType File -Path "SAK-Utility-v0.5.1/portable.ini" -Force
        
        # Create ZIP archive
        Compress-Archive -Path "SAK-Utility-v0.5.1" -DestinationPath "SAK-Utility-v0.5.1-Windows-x64.zip" -Force
    
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SAK-Utility-Windows-x64
        path: build/Release/SAK-Utility-v0.5.1-Windows-x64.zip
        retention-days: 90
    
    - name: Upload Executable Only
      uses: actions/upload-artifact@v4
      with:
        name: sak_utility.exe
        path: build/Release/sak_utility.exe
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/Release/SAK-Utility-v0.5.1-Windows-x64.zip
        body: |
          # S.A.K. Utility v0.5.1
          
          **Windows System Administration Kit - Swiss Army Knife Utility**
          
          ## New in v0.5.1
          - ðŸ” **AES-256-CBC Encryption** for user profile backups (PBKDF2, 100k iterations)
          - ðŸ“¦ **Compression Support** with 4 levels (None, Fast, Balanced, Maximum)
          - ðŸ’¿ **Image Flasher** with Windows ISO downloader and USB drive safety checks
          - âš¡ **Streaming Decompression** for gzip, bzip2, and xz formats
          
          ## Core Features
          - ðŸš€ Application Migration with embedded Chocolatey
          - ðŸ’¾ User Profile Backup & Restore wizards with encryption
          - ðŸ’¿ Image Flasher with Windows ISO downloader
          - ðŸ“‚ Directory Organizer
          - ðŸ” Duplicate File Finder
          - ðŸ—ï¸ License Key Scanner
          
          ## Installation
          1. Download `SAK-Utility-v0.5.1-Windows-x64.zip`
          2. Extract to your preferred location
          3. Run `sak_utility.exe`
          4. `portable.ini` is included for portable operation
          
          ## Requirements
          - Windows 10/11 x64
          - Administrator privileges (for app migration and license scanning)
          
          ## Notes
          - Build: ${{ github.sha }}
          - Built with: C++23, Qt 6.5.3, MSVC 2022
          - All dependencies included (no separate installation required)
          
          See [README.md](https://github.com/${{ github.repository }}/blob/main/Readme.md) for full documentation.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Display Build Info
      run: |
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: 0.5.1" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Qt Version**: ${{ env.QT_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **CMake Version**: ${{ env.CMAKE_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type**: ${{ env.BUILD_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Changes" >> $GITHUB_STEP_SUMMARY
        git log --oneline -5 >> $GITHUB_STEP_SUMMARY
