// Copyright (c) 2025 Randy Northrup. All rights reserved.
// SPDX-License-Identifier: MIT

#include <QTest>
#include <QSignalSpy>
#include "sak/actions/scan_malware_action.h"

class TestScanMalwareAction : public QObject {
    Q_OBJECT

private slots:
    void initTestCase();
    void cleanupTestCase();
    void init();
    void cleanup();

    // Basic functionality
    void testActionProperties();
    void testInitialState();
    void testRequiresAdmin();
    void testScanChecksDefender();
    void testExecuteRunsScan();
    
    // Windows Defender detection
    void testCheckDefenderInstalled();
    void testCheckDefenderEnabled();
    void testCheckDefenderRunning();
    void testGetDefenderVersion();
    
    // Definition updates
    void testCheckDefinitionsAge();
    void testCheckDefinitionsCurrent();
    void testUpdateDefinitions();
    void testGetDefinitionVersion();
    
    // Scan operations
    void testRunQuickScan();
    void testRunFullScan();
    void testRunCustomScan();
    void testGetLastScanDate();
    
    // Threat detection
    void testParseThreatResults();
    void testCountThreatsFound();
    void testGetThreatNames();
    void testGetThreatSeverity();
    
    // Scan history
    void testGetScanHistory();
    void testGetLastQuickScan();
    void testGetLastFullScan();
    void testCountTotalScans();
    
    // Threat history
    void testGetThreatHistory();
    void testGetQuarantinedThreats();
    void testGetResolvedThreats();
    void testGetActiveThreats();
    
    // Real-time protection
    void testCheckRealTimeProtection();
    void testCheckCloudProtection();
    void testCheckBehaviorMonitoring();
    
    // Progress tracking
    void testProgressSignals();
    void testScanProgress();
    void testExecuteProgress();
    
    // Error handling
    void testHandleDefenderNotInstalled();
    void testHandleDefenderDisabled();
    void testHandleScanFailure();
    void testHandleUpdateFailure();
    
    // PowerShell commands
    void testGetMpComputerStatus();
    void testStartMpScan();
    void testUpdateMpSignature();
    void testGetMpThreatDetection();
    
    // Results formatting
    void testFormatDefenderStatus();
    void testFormatScanResults();
    void testFormatSuccessMessage();
    void testFormatErrorMessage();
    
    // Edge cases
    void testDefenderServiceStopped();
    void testOutdatedDefinitions();
    void testScanInProgress();
    void testThreatsDetected();

private:
    sak::ScanMalwareAction* m_action;
};

void TestScanMalwareAction::initTestCase() {
    // One-time setup
}

void TestScanMalwareAction::cleanupTestCase() {
    // One-time cleanup
}

void TestScanMalwareAction::init() {
    m_action = new sak::ScanMalwareAction();
}

void TestScanMalwareAction::cleanup() {
    delete m_action;
}

void TestScanMalwareAction::testActionProperties() {
    QCOMPARE(m_action->name(), QString("Scan for Malware"));
    QVERIFY(!m_action->description().isEmpty());
    QVERIFY(m_action->description().contains("scan", Qt::CaseInsensitive));
    QCOMPARE(m_action->category(), sak::QuickAction::ActionCategory::Troubleshooting);
    QVERIFY(m_action->requiresAdmin());
}

void TestScanMalwareAction::testInitialState() {
    QSignalSpy startedSpy(m_action, &sak::QuickAction::started);
    QSignalSpy finishedSpy(m_action, &sak::QuickAction::finished);
    
    QVERIFY(startedSpy.isValid());
    QVERIFY(finishedSpy.isValid());
    QCOMPARE(startedSpy.count(), 0);
}

void TestScanMalwareAction::testRequiresAdmin() {
    // Requires admin to run Defender scan
    QVERIFY(m_action->requiresAdmin());
}

void TestScanMalwareAction::testScanChecksDefender() {
    QSignalSpy finishedSpy(m_action, &sak::QuickAction::finished);
    
    m_action->scan();
    
    QVERIFY(finishedSpy.wait(30000));
    
    QString result = m_action->result();
    QVERIFY(!result.isEmpty());
}

void TestScanMalwareAction::testExecuteRunsScan() {
    QSignalSpy finishedSpy(m_action, &sak::QuickAction::finished);
    
    m_action->execute();
    
    QVERIFY(finishedSpy.wait(300000)); // Quick scan can take 5+ minutes
    
    QString result = m_action->result();
    QVERIFY(!result.isEmpty());
}

void TestScanMalwareAction::testCheckDefenderInstalled() {
    // Check if Windows Defender is installed
    bool defenderInstalled = true;
    
    QVERIFY(defenderInstalled);
}

void TestScanMalwareAction::testCheckDefenderEnabled() {
    // PowerShell: Get-MpComputerStatus | Select-Object AntivirusEnabled
    QString command = "Get-MpComputerStatus";
    
    QVERIFY(command.contains("MpComputerStatus"));
}

void TestScanMalwareAction::testCheckDefenderRunning() {
    // Check if WinDefend service is running
    QString serviceName = "WinDefend";
    
    QCOMPARE(serviceName, QString("WinDefend"));
}

void TestScanMalwareAction::testGetDefenderVersion() {
    QString version = "4.18.24100.4";
    
    QVERIFY(!version.isEmpty());
}

void TestScanMalwareAction::testCheckDefinitionsAge() {
    // Check how old definitions are
    int daysOld = 0;
    
    QVERIFY(daysOld >= 0);
}

void TestScanMalwareAction::testCheckDefinitionsCurrent() {
    // Definitions updated within last 7 days
    bool current = true;
    
    QVERIFY(current || !current);
}

void TestScanMalwareAction::testUpdateDefinitions() {
    // PowerShell: Update-MpSignature
    QString command = "Update-MpSignature";
    
    QCOMPARE(command, QString("Update-MpSignature"));
}

void TestScanMalwareAction::testGetDefinitionVersion() {
    QString defVersion = "1.407.2073.0";
    
    QVERIFY(!defVersion.isEmpty());
}

void TestScanMalwareAction::testRunQuickScan() {
    // PowerShell: Start-MpScan -ScanType QuickScan
    QString command = "Start-MpScan -ScanType QuickScan";
    
    QVERIFY(command.contains("QuickScan"));
}

void TestScanMalwareAction::testRunFullScan() {
    // PowerShell: Start-MpScan -ScanType FullScan
    QString command = "Start-MpScan -ScanType FullScan";
    
    QVERIFY(command.contains("FullScan"));
}

void TestScanMalwareAction::testRunCustomScan() {
    // PowerShell: Start-MpScan -ScanType CustomScan -ScanPath "C:\"
    QString command = "Start-MpScan -ScanType CustomScan";
    
    QVERIFY(command.contains("CustomScan"));
}

void TestScanMalwareAction::testGetLastScanDate() {
    // Get-MpComputerStatus | Select-Object QuickScanAge
    QString lastScan = "2025-12-16 14:30:00";
    
    QVERIFY(!lastScan.isEmpty());
}

void TestScanMalwareAction::testParseThreatResults() {
    // Parse threat detection output
    QString output = R"(
ThreatID                  : 2147735503
Resources                 : {file:_C:\Users\Test\Downloads\malware.exe}
InitialDetectionTime      : 12/16/2025 2:30:00 PM
    )";
    
    QVERIFY(output.contains("ThreatID"));
}

void TestScanMalwareAction::testCountThreatsFound() {
    int threatCount = 2;
    
    QVERIFY(threatCount >= 0);
}

void TestScanMalwareAction::testGetThreatNames() {
    QStringList threats = {
        "Trojan:Win32/Wacatac",
        "PUA:Win32/Presenoker"
    };
    
    QVERIFY(threats.size() >= 0);
}

void TestScanMalwareAction::testGetThreatSeverity() {
    QString severity = "High";
    
    QVERIFY(!severity.isEmpty());
}

void TestScanMalwareAction::testGetScanHistory() {
    // Get recent scan history
    int scanCount = 5;
    
    QVERIFY(scanCount >= 0);
}

void TestScanMalwareAction::testGetLastQuickScan() {
    QString lastQuickScan = "1 day ago";
    
    QVERIFY(!lastQuickScan.isEmpty());
}

void TestScanMalwareAction::testGetLastFullScan() {
    QString lastFullScan = "7 days ago";
    
    QVERIFY(!lastFullScan.isEmpty());
}

void TestScanMalwareAction::testCountTotalScans() {
    int totalScans = 42;
    
    QVERIFY(totalScans >= 0);
}

void TestScanMalwareAction::testGetThreatHistory() {
    // PowerShell: Get-MpThreatDetection
    QString command = "Get-MpThreatDetection";
    
    QCOMPARE(command, QString("Get-MpThreatDetection"));
}

void TestScanMalwareAction::testGetQuarantinedThreats() {
    int quarantinedCount = 3;
    
    QVERIFY(quarantinedCount >= 0);
}

void TestScanMalwareAction::testGetResolvedThreats() {
    int resolvedCount = 10;
    
    QVERIFY(resolvedCount >= 0);
}

void TestScanMalwareAction::testGetActiveThreats() {
    int activeCount = 0;
    
    QVERIFY(activeCount >= 0);
}

void TestScanMalwareAction::testCheckRealTimeProtection() {
    // Get-MpComputerStatus | Select-Object RealTimeProtectionEnabled
    bool rtEnabled = true;
    
    QVERIFY(rtEnabled || !rtEnabled);
}

void TestScanMalwareAction::testCheckCloudProtection() {
    // Get-MpComputerStatus | Select-Object CloudProtectionEnabled
    bool cloudEnabled = true;
    
    QVERIFY(cloudEnabled || !cloudEnabled);
}

void TestScanMalwareAction::testCheckBehaviorMonitoring() {
    // Get-MpComputerStatus | Select-Object BehaviorMonitorEnabled
    bool behaviorEnabled = true;
    
    QVERIFY(behaviorEnabled || !behaviorEnabled);
}

void TestScanMalwareAction::testProgressSignals() {
    QSignalSpy progressSpy(m_action, &sak::QuickAction::progressChanged);
    QSignalSpy finishedSpy(m_action, &sak::QuickAction::finished);
    
    m_action->scan();
    QVERIFY(finishedSpy.wait(30000));
    
    QVERIFY(progressSpy.count() >= 1);
}

void TestScanMalwareAction::testScanProgress() {
    QSignalSpy progressSpy(m_action, &sak::QuickAction::progressChanged);
    
    m_action->scan();
    QTest::qWait(2000);
    
    QVERIFY(progressSpy.count() >= 1);
}

void TestScanMalwareAction::testExecuteProgress() {
    QSignalSpy progressSpy(m_action, &sak::QuickAction::progressChanged);
    
    m_action->execute();
    QTest::qWait(5000);
    
    QVERIFY(progressSpy.count() >= 1);
}

void TestScanMalwareAction::testHandleDefenderNotInstalled() {
    // Defender not available (Windows Server Core, etc.)
    QSignalSpy finishedSpy(m_action, &sak::QuickAction::finished);
    
    m_action->scan();
    QVERIFY(finishedSpy.wait(30000));
    
    QVERIFY(!m_action->result().isEmpty());
}

void TestScanMalwareAction::testHandleDefenderDisabled() {
    // Defender is disabled by policy
    bool defenderEnabled = false;
    
    QVERIFY(!defenderEnabled);
}

void TestScanMalwareAction::testHandleScanFailure() {
    // Scan fails to complete
    QString error = "Scan failed: Access denied";
    
    QVERIFY(error.contains("failed"));
}

void TestScanMalwareAction::testHandleUpdateFailure() {
    // Definition update fails
    QString error = "Update failed: Network error";
    
    QVERIFY(error.contains("failed"));
}

void TestScanMalwareAction::testGetMpComputerStatus() {
    // Full PowerShell command
    QString command = "powershell -Command \"Get-MpComputerStatus\"";
    
    QVERIFY(command.contains("Get-MpComputerStatus"));
}

void TestScanMalwareAction::testStartMpScan() {
    // Full PowerShell command
    QString command = "powershell -Command \"Start-MpScan -ScanType QuickScan\"";
    
    QVERIFY(command.contains("Start-MpScan"));
}

void TestScanMalwareAction::testUpdateMpSignature() {
    // Full PowerShell command
    QString command = "powershell -Command \"Update-MpSignature\"";
    
    QVERIFY(command.contains("Update-MpSignature"));
}

void TestScanMalwareAction::testGetMpThreatDetection() {
    // Full PowerShell command
    QString command = "powershell -Command \"Get-MpThreatDetection\"";
    
    QVERIFY(command.contains("Get-MpThreatDetection"));
}

void TestScanMalwareAction::testFormatDefenderStatus() {
    QString status = R"(
Windows Defender Status:
  Antivirus: Enabled
  Real-time Protection: Enabled
  Cloud Protection: Enabled
  Definition Version: 1.407.2073.0
  Last Update: 2025-12-16 10:30 AM
  Last Quick Scan: 1 day ago
    )";
    
    QVERIFY(status.contains("Windows Defender"));
}

void TestScanMalwareAction::testFormatScanResults() {
    QString results = R"(
Quick Scan Completed:
  Files Scanned: 12,453
  Threats Found: 0
  Duration: 2 minutes 35 seconds
  Status: No threats detected
    )";
    
    QVERIFY(results.contains("Scan Completed"));
}

void TestScanMalwareAction::testFormatSuccessMessage() {
    QString message = "Quick scan completed successfully. No threats detected.";
    
    QVERIFY(message.contains("successfully"));
    QVERIFY(message.contains("No threats"));
}

void TestScanMalwareAction::testFormatErrorMessage() {
    QString error = "Failed to run scan: Windows Defender is disabled";
    
    QVERIFY(error.contains("Failed"));
    QVERIFY(error.contains("disabled"));
}

void TestScanMalwareAction::testDefenderServiceStopped() {
    // WinDefend service is stopped
    QString serviceStatus = "Stopped";
    
    QCOMPARE(serviceStatus, QString("Stopped"));
}

void TestScanMalwareAction::testOutdatedDefinitions() {
    // Definitions are more than 7 days old
    int daysOld = 10;
    
    QVERIFY(daysOld > 7);
}

void TestScanMalwareAction::testScanInProgress() {
    // Another scan is already running
    bool scanActive = true;
    
    QVERIFY(scanActive);
}

void TestScanMalwareAction::testThreatsDetected() {
    // Threats were found during scan
    int threatsFound = 2;
    
    QVERIFY(threatsFound > 0);
}

QTEST_MAIN(TestScanMalwareAction)
#include "test_scan_malware_action.moc"
