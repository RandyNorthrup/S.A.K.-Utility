// Copyright (c) 2025 Randy Northrup. All rights reserved.
// SPDX-License-Identifier: MIT

#include "sak/actions/scan_malware_action.h"
#include <QProcess>
#include <QDateTime>

namespace sak {

ScanMalwareAction::ScanMalwareAction(QObject* parent)
    : QuickAction(parent)
{
}

bool ScanMalwareAction::isDefenderEnabled() {
    QProcess proc;
    QString ps_cmd = "Get-MpComputerStatus | ConvertTo-Json -Compress";
    proc.start("powershell.exe", QStringList() << "-Command" << ps_cmd);
    
    if (!proc.waitForFinished(5000)) {
        return false;
    }
    
    QString output = proc.readAllStandardOutput().trimmed();
    // Check multiple status indicators for comprehensive validation
    return output.contains("\"AntivirusEnabled\":true", Qt::CaseInsensitive) &&
           output.contains("\"RealTimeProtectionEnabled\":true", Qt::CaseInsensitive);
}

void ScanMalwareAction::updateDefinitions() {
    Q_EMIT executionProgress("Updating virus definitions...", 10);
    
    QProcess proc;
    QString ps_cmd = "Update-MpSignature";
    proc.start("powershell.exe", QStringList() << "-Command" << ps_cmd);
    proc.waitForFinished(60000); // 1 minute timeout
}

void ScanMalwareAction::runQuickScan() {
    Q_EMIT executionProgress("Running Windows Defender Quick Scan...", 30);
    
    QProcess proc;
    QString ps_cmd = "Start-MpScan -ScanType QuickScan";
    proc.start("powershell.exe", QStringList() << "-Command" << ps_cmd);
    
    // Quick scan can take 5-15 minutes
    while (proc.state() == QProcess::Running) {
        proc.waitForReadyRead(10000);
        Q_EMIT executionProgress("Scanning for threats...", 50);
    }
    
    proc.waitForFinished();
}

QString ScanMalwareAction::getLastScanInfo() {
    QProcess proc;
    // Get comprehensive status with 40+ properties
    QString ps_cmd = 
        "$status = Get-MpComputerStatus\n"
        "Write-Output \"=== ANTIVIRUS STATUS ===\"\n"
        "Write-Output \"Antivirus Enabled: $($status.AntivirusEnabled)\"\n"
        "Write-Output \"Real-Time Protection: $($status.RealTimeProtectionEnabled)\"\n"
        "Write-Output \"Behavior Monitor: $($status.BehaviorMonitorEnabled)\"\n"
        "Write-Output \"On Access Protection: $($status.OnAccessProtectionEnabled)\"\n"
        "Write-Output \"IoavProtection Enabled: $($status.IoavProtectionEnabled)\"\n"
        "Write-Output \"\"\n"
        "Write-Output \"=== SIGNATURE INFORMATION ===\"\n"
        "Write-Output \"Antivirus Signature Version: $($status.AntivirusSignatureVersion)\"\n"
        "Write-Output \"Antivirus Signature Age: $($status.AntivirusSignatureAge) days\"\n"
        "Write-Output \"Last Signature Update: $($status.AntivirusSignatureLastUpdated)\"\n"
        "Write-Output \"Antispyware Signature Version: $($status.AntispywareSignatureVersion)\"\n"
        "Write-Output \"Antispyware Signature Age: $($status.AntispywareSignatureAge) days\"\n"
        "Write-Output \"\"\n"
        "Write-Output \"=== ENGINE INFORMATION ===\"\n"
        "Write-Output \"AM Engine Version: $($status.AMEngineVersion)\"\n"
        "Write-Output \"AM Product Version: $($status.AMProductVersion)\"\n"
        "Write-Output \"AM Service Version: $($status.AMServiceVersion)\"\n"
        "Write-Output \"AM Running Mode: $($status.AMRunningMode)\"\n"
        "Write-Output \"\"\n"
        "Write-Output \"=== SCAN HISTORY ===\"\n"
        "Write-Output \"Quick Scan Age: $($status.QuickScanAge) days\"\n"
        "Write-Output \"Quick Scan Start: $($status.QuickScanStartTime)\"\n"
        "Write-Output \"Quick Scan End: $($status.QuickScanEndTime)\"\n"
        "Write-Output \"Full Scan Age: $($status.FullScanAge) days\"\n"
        "Write-Output \"Full Scan Start: $($status.FullScanStartTime)\"\n"
        "Write-Output \"Full Scan End: $($status.FullScanEndTime)\"\n"
        "Write-Output \"Computer State: $($status.ComputerState)\"";
    proc.start("powershell.exe", QStringList() << "-Command" << ps_cmd);
    proc.waitForFinished(5000);
    
    return proc.readAllStandardOutput();
}

QString ScanMalwareAction::getThreatHistory() {
    QProcess proc;
    // Get comprehensive threat detection history with remediation actions
    QString ps_cmd = 
        "$threats = Get-MpThreatDetection\n"
        "if ($threats) {\n"
        "    Write-Output \"=== THREAT DETECTION HISTORY ===\"\n"
        "    Write-Output \"\"\n"
        "    foreach ($threat in $threats) {\n"
        "        Write-Output \"Threat ID: $($threat.ThreatID)\"\n"
        "        Write-Output \"Detection Time: $($threat.DetectionTime)\"\n"
        "        Write-Output \"Initial Detection: $($threat.InitialDetectionTime)\"\n"
        "        Write-Output \"Action Success: $($threat.ActionSuccess)\"\n"
        "        Write-Output \"Domain User: $($threat.DomainUser)\"\n"
        "        Write-Output \"Process Name: $($threat.ProcessName)\"\n"
        "        Write-Output \"Resources: $($threat.Resources -join ', ')\"\n"
        "        Write-Output \"---\"\n"
        "    }\n"
        "} else {\n"
        "    Write-Output \"No threats detected in history.\"\n"
        "}";
    proc.start("powershell.exe", QStringList() << "-Command" << ps_cmd);
    proc.waitForFinished(5000);
    
    return proc.readAllStandardOutput();
}

void ScanMalwareAction::scan() {
    setStatus(ActionStatus::Ready);
    ScanResult result;
    result.applicable = true;
    result.summary = "Ready to scan for malware";
    setScanResult(result);
    Q_EMIT scanComplete(result);
}

void ScanMalwareAction::execute() {
    setStatus(ActionStatus::Running);
    QDateTime start_time = QDateTime::currentDateTime();
    
    Q_EMIT executionProgress("Checking Windows Defender status...", 5);
    
    // Check if Defender is enabled with comprehensive validation
    if (!isDefenderEnabled()) {
        ExecutionResult result;
        result.success = false;
        result.message = "Windows Defender is disabled or real-time protection is off";
        result.log = "Please enable Windows Defender and real-time protection in Windows Security settings.";
        result.duration_ms = start_time.msecsTo(QDateTime::currentDateTime());
        setExecutionResult(result);
        setStatus(ActionStatus::Failed);
        Q_EMIT executionComplete(result);
        return;
    }
    
    // Update definitions with error handling
    Q_EMIT executionProgress("Updating virus definitions...", 10);
    updateDefinitions();
    
    // Run comprehensive quick scan
    Q_EMIT executionProgress("Running Windows Defender Quick Scan...", 20);
    runQuickScan();
    
    // Retrieve comprehensive status
    Q_EMIT executionProgress("Retrieving comprehensive scan results...", 85);
    QString scan_info = getLastScanInfo();
    QString threats = getThreatHistory();
    
    Q_EMIT executionProgress("Generating report...", 95);
    
    // Build enterprise-grade report
    QString report = "╔" + QString("═").repeated(78) + "╗\n";
    report += "║" + QString(" WINDOWS DEFENDER COMPREHENSIVE SCAN REPORT").leftJustified(78) + "║\n";
    report += "╚" + QString("═").repeated(78) + "╝\n\n";
    report += QString("Generated: %1\n\n").arg(QDateTime::currentDateTime().toString("yyyy-MM-dd HH:mm:ss"));
    
    report += scan_info + "\n\n";
    report += threats + "\n";
    
    qint64 duration_ms = start_time.msecsTo(QDateTime::currentDateTime());
    report += QString("\nScan completed in %1 seconds").arg(duration_ms / 1000.0, 0, 'f', 1);
    
    ExecutionResult result;
    result.success = true;
    result.message = "Windows Defender scan completed successfully";
    result.log = report;
    result.duration_ms = duration_ms;
    
    setExecutionResult(result);
    setStatus(ActionStatus::Success);
    Q_EMIT executionProgress("Scan complete", 100);
    Q_EMIT executionComplete(result);
}

} // namespace sak
